<template>
  <ion-page>
    <ion-content class="ion-padding login-page" color="primary">
      <!-- Logo -->
      <div class="logo-container">
        <img src="/logo.png" alt="Gymetra Logo" class="logo" />
      </div>

      <!-- Campo Usuario -->
      <ion-item>
        <ion-icon slot="start" :icon="personOutline"></ion-icon>
        <ion-input
          v-model="email"
          type="email"
          label="Usuario"
          label-placement="floating"
          fill="outline"
          placeholder="Correo electrónico"
        ></ion-input>
      </ion-item>

      <!-- Campo Contraseña -->
      <ion-item>
        <ion-icon slot="start" :icon="keyOutline"></ion-icon>
        <ion-input
          v-model="password"
          :type="showPassword ? 'text' : 'password'"
          label="Contraseña"
          label-placement="floating"
          fill="outline"
          placeholder="Contraseña"
        ></ion-input>
        <ion-icon
          slot="end"
          :icon="showPassword ? eyeOffOutline : eyeOutline"
          @click="togglePassword"
          style="cursor: pointer"
        ></ion-icon>
      </ion-item>

      <!-- Links -->
      <div class="links">
        <a href="#">Olvidaste tu contraseña?</a>
        <p>
          Nuevo miembro? <a href="#">Regístrate</a>
        </p>
      </div>

      <!-- Botón -->
      <div class="btn-container">
        <ion-button expand="block" class="login-btn" @click="handleLogin" :disabled="loading">
          <ion-spinner v-if="loading" name="crescent"></ion-spinner>
          <span v-else>Ingresar</span>
        </ion-button>
      </div>

      <!-- Error -->
      <div v-if="errorMessage" class="error-msg">
        {{ errorMessage }}
      </div>
    </ion-content>
  </ion-page>
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue";
import { useRouter } from "vue-router";
import {
  IonPage,
  IonContent,
  IonItem,
  IonInput,
  IonButton,
  IonIcon,
  IonSpinner,
} from "@ionic/vue";
import {
  personOutline,
  keyOutline,
  eyeOutline,
  eyeOffOutline,
} from "ionicons/icons";
import { login } from "../services/authService"; // servicio de login
import { useAuthStore } from "@/stores/auth";
import jwt_decode from "jwt-decode";

// Estado local
const email = ref("");
const password = ref("");
const showPassword = ref(false);
const loading = ref(false);
const errorMessage = ref("");

// Router y store
const router = useRouter();
const auth = useAuthStore();

// Enfocar input de email al cargar
onMounted(() => {
  document.querySelector<HTMLInputElement>('ion-input input')?.focus();
});

// Alternar visibilidad de la contraseña
const togglePassword = () => {
  showPassword.value = !showPassword.value;
};

// Manejar login
const handleLogin = async () => {
  errorMessage.value = "";
  loading.value = true;

  try {
    // Validación básica
    if (!email.value || !password.value) {
      errorMessage.value = "Por favor ingresa usuario y contraseña";
      loading.value = false;
      return;
    }

    // Llamada al servicio de login
    const res = await login(email.value, password.value);

    if (res.token) {
      // Guardar token en el store y localStorage
      auth.setToken(res.token);

      // Decodificar token
      const decoded: any = jwt_decode(res.token);

      // Validar rol de cliente (roleId 2)
      if (!decoded.roleIds || !decoded.roleIds.includes(2)) {
        alert("❌ Acceso denegado: Esta área es solo para clientes");
        router.push("/login");
        return;
      }

      // Redirigir a Home
      router.push({
        path: "/home",
        name: "Home",
        meta: { requiresAuth: true },
      });
    }
  } catch (err: any) {
    errorMessage.value = err.response?.data?.message || "Error al iniciar sesión";
  } finally {
    loading.value = false;
  }
};
</script>

<style scoped>
/* Fondo de toda la página */
.login-page {
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 100%;
}

/* Logo centrado y responsivo */
.logo-container {
  display: flex;
  justify-content: center;
  margin: 40px 0 30px;
}

.logo {
  width: 60%;
  max-width: 300px;
  height: auto;
}

@media (max-width: 768px) {
  .logo {
    width: 80%;
    max-width: 250px;
  }
}

@media (min-width: 1024px) {
  .logo {
    width: 40%;
    max-width: 350px;
  }
}

/* Inputs */
ion-item {
  margin-bottom: 15px;
  border-radius: 10px;
}

/* Links */
.links {
  text-align: center;
  margin: 20px 0;
}
.links a {
  color: red;
  text-decoration: none;
  font-weight: bold;
}
.links p {
  margin-top: 10px;
  color: white;
}

/* Botón personalizado */
.btn-container {
  display: flex;
  justify-content: center;
}

.login-btn {
  --background: black;
  --color: white;
  border-radius: 25px;
  width: 80%;
  max-width: 300px;
}

/* Error */
.error-msg {
  margin-top: 15px;
  color: #ff4d4f;
  font-weight: bold;
  text-align: center;
}
</style>
